<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bowling League Tracker • Big Ben</title>
<style>
  :root{
    --bg:#0e1116; --card:#171a21; --fg:#e7ecf3; --muted:#9fb2cc; --accent:#2c84ff;
    --ink:#cfe0fb; --line:#2a3140; --panel:#111623;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);
       font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

  .wrap{max-width:960px;margin:0 auto;padding:20px}
  .card{background:var(--card);border-radius:16px;padding:16px;
        box-shadow:0 6px 20px rgba(0,0,0,.25)}
  h1{margin:0 0 8px;font-size:24px}
  h2{margin:12px 0 8px;font-size:18px;color:var(--muted)}
  img{width:100%;height:auto;border-radius:12px}

  .tabs{display:flex;gap:8px;margin:12px 0}
  .tab{flex:1;text-align:center;padding:10px 12px;border-radius:10px;
       background:#0b0e13;color:#a9bfdc;cursor:pointer}
  .tab.active{background:var(--accent);color:#fff;font-weight:700}

  label{font-size:14px;color:var(--ink);display:block;margin-bottom:4px}
  input,select,textarea{
    width:100%;background:#0b0e13;border:1px solid var(--line);
    border-radius:10px;color:var(--fg);padding:10px
  }
  .btn{display:inline-block;background:var(--accent);color:#fff;border:none;
       border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.ghost{background:#0b0e13;border:1px solid var(--line);color:var(--ink)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b0e13;
        border:1px solid var(--line);color:var(--ink);font-size:12px}

  /* ------- Scoresheet layout ------- */
  #framesRow{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  @media (min-width:900px){#framesRow{grid-template-columns:repeat(10,1fr)}}

  .frameCard{
    background:#0b0e13;border:1px solid var(--line);border-radius:10px;
    padding:8px;position:relative;min-height:110px
  }
  .frameHead{display:flex;justify-content:space-between;align-items:flex-start}
  .frameNum{font-weight:700;color:var(--ink)}

  .shots{display:grid;grid-template-columns:repeat(2,22px);gap:4px}
  .shots.triple{grid-template-columns:repeat(3,22px)}
  .shot{
    width:22px;height:22px;text-align:center;font-weight:700;
    background:#121722;border:1px solid var(--line);border-radius:4px;color:#fff
  }
  .frameTotal{
    position:absolute;left:8px;right:8px;bottom:8px;height:34px;
    border:1px solid var(--line);border-radius:6px;background:var(--panel);
    display:flex;align-items:center;justify-content:center;font-weight:800
  }

  /* minor spacing */
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .hint{font-size:13px;color:#9fb2cc}
  .foot{margin-top:10px;color:#9fb2cc;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Bowling League Tracker • Big Ben (44 ft)</h1>

    <div class="tabs">
      <div class="tab active" data-panel="plan">Lane Plan</div>
      <div class="tab" data-panel="entry">Score Entry</div>
      <div class="tab" data-panel="history">History</div>
    </div>

    <!-- PLAN PANEL -->
    <section id="plan" class="panel">
      <div class="grid grid-2">
        <div>
          <img src="assets/BigBen-LanePlan.png" alt="Big Ben lane plan">
          <p class="foot">Solid: Forge (~13 → 8 → pocket). Dashed: Jackal (~17 → 10 → pocket). Blue = oil to 44 ft.</p>
          <div class="flex">
            <a class="btn" href="assets/BigBen-LanePlan.png" download>Download PNG</a>
            <a class="btn ghost" href="sheets/League Night Entry (import to your tracker).xlsx" download>Entry Sheet (XLSX)</a>
          </div>
        </div>
        <div>
          <h2>Tonight’s Quick Notes</h2>
          <label for="qNotes">Optional — saved on this device</label>
          <textarea id="qNotes" rows="6" placeholder="e.g., Start Forge 13→8. If flat 10s by frame 5, move 2-and-1 or switch to Jackal."></textarea>
          <div class="flex">
            <button class="btn" id="saveQuickNotes">Save Notes</button>
            <span class="hint" id="quickSaved"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- ENTRY PANEL -->
    <section id="entry" class="panel" style="display:none">
      <h2>Score Entry (X, /, -, 0–9) — Auto-scoring</h2>
      <div class="grid">
        <div class="flex">
          <div>
            <label for="date">Date</label>
            <input id="date" type="date">
          </div>
          <div>
            <label for="gameNum">Game</label>
            <select id="gameNum">
              <option value="1">Game 1</option>
              <option value="2">Game 2</option>
              <option value="3">Game 3</option>
            </select>
          </div>
          <div>
            <label>Total</label>
            <div class="pill" id="gameTotal">0</div>
          </div>
        </div>

        <!-- 10 frames -->
        <div class="row" id="framesRow"></div>

        <div>
          <label for="notes">Notes for this game (saved with entry)</label>
          <textarea id="notes" rows="4" placeholder="e.g., Flat 10s frame 6, moved 2-1, carry improved."></textarea>
        </div>

        <div class="flex">
          <button class="btn" id="saveGame">Save Game</button>
          <button class="btn ghost" id="resetGame">Clear</button>
          <span class="hint">Tip: Enter 10th as X/X/X or 9/9 etc.</span>
        </div>

        <div class="flex">
          <div><span class="pill" id="g1Pill">G1: —</span></div>
          <div><span class="pill" id="g2Pill">G2: —</span></div>
          <div><span class="pill" id="g3Pill">G3: —</span></div>
          <div><span class="pill" id="seriesPill">Series: —</span></div>
        </div>
      </div>
    </section>

    <!-- HISTORY PANEL -->
    <section id="history" class="panel" style="display:none">
      <h2>History (saved on this device)</h2>
      <table id="histTable">
        <thead>
          <tr><th>Date</th><th>G1</th><th>G2</th><th>G3</th><th>High</th><th>Low</th><th>Series</th><th>Copy</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="flex" style="margin-top:8px">
        <button class="btn ghost" id="exportCSV">Export CSV</button>
        <input type="file" id="importCSV" accept=".csv" style="display:none" />
        <button class="btn ghost" id="importBtn">Import CSV</button>
        <button class="btn" id="clearAll">Clear All (device)</button>
      </div>
      <p class="foot">“Copy” puts a tab-separated row on your clipboard (Date, G1, G2, G3, High, Low, Series) ready to paste into your **Main** sheet.</p>
    </section>
  </div>
</div>

<script>
/* ---------- tabs ---------- */
const tabs=[...document.querySelectorAll('.tab')];
tabs.forEach(t=>t.onclick=()=>{tabs.forEach(x=>x.classList.remove('active'));t.classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.style.display='none');
  document.getElementById(t.dataset.panel).style.display='block';
});

/* ---------- frames UI ---------- */
const framesRow=document.getElementById('framesRow');
function buildFrames(){
  framesRow.innerHTML = '';
  for (let f = 1; f <= 10; f++) {
    const box = document.createElement('div');
    box.className = 'frameCard';
    box.innerHTML = `
      <div class="frameHead">
        <span class="frameNum">${f}</span>
        <div class="shots ${f===10?'triple':''}">
          <input class="shot" data-f="${f}" data-r="1" maxlength="1">
          <input class="shot" data-f="${f}" data-r="2" maxlength="1">
          <input class="shot" data-f="${f}" data-r="3" maxlength="1" ${f<10?'disabled':''}>
        </div>
      </div>
      <div class="frameTotal" data-ft="${f}"> </div>
    `;
    framesRow.appendChild(box);
  }
}

buildFrames();

/* ---------- scoring ---------- */
function symToPins(sym, prev=0){
  if(!sym) return 0;
  sym=sym.toUpperCase();
  if(sym==='X') return 10;
  if(sym==='/') return Math.max(0,10-prev);
  if(sym==='-') return 0;
  const n=parseInt(sym,10);
  return isNaN(n)?0:n;
}
function readGame(){
  const rolls=[];
  for(let f=1; f<=10; f++){
    const r1=document.querySelector(`input[data-f="${f}"][data-r="1"]`).value.trim().toUpperCase();
    const r2=document.querySelector(`input[data-f="${f}"][data-r="2"]`).value.trim().toUpperCase();
    const r3=document.querySelector(`input[data-f="${f}"][data-r="3"]`).value.trim().toUpperCase();
    if(f<10){
      if(r1==='X'){ rolls.push(10); }
      else{
        const p1=symToPins(r1);
        const p2=symToPins(r2,p1);
        rolls.push(p1,p2);
      }
    }else{
      // 10th
      const p1=symToPins(r1);
      const p2=(r1==='X')?symToPins(r2):symToPins(r2,p1);
      const p3=(r2==='X'||r2==='/'||r1==='X')?symToPins(r3,(r2==='/')?0:p2):0;
      // emulate raw rolls for scoring
      if(r1==='X'){ rolls.push(10);
        if(r2==='X'){ rolls.push(10); rolls.push(p3); }
        else { rolls.push(p2); rolls.push(p3); }
      } else {
        rolls.push(p1);
        if(r2==='/'){ rolls.push(10-p1); rolls.push(p3); }
        else { rolls.push(p2); }
      }
    }
  }
  return rolls;
}
function scoreGame(){
  const rolls = readGame();
  let i = 0, total = 0;

  for (let f = 1; f <= 10; f++) {
    // --- Frames 1..9 behave normally ---
    if (f < 10) {
      if (rolls[i] === 10) { // strike
        total += 10 + (rolls[i+1] ?? 0) + (rolls[i+2] ?? 0);
        i += 1;
      } else {
        const frame = (rolls[i] ?? 0) + (rolls[i+1] ?? 0);
        if (frame === 10) { // spare
          total += 10 + (rolls[i+2] ?? 0);
        } else {
          total += frame;
        }
        i += 2;
      }
      continue;
    }
function renderFrameTotals(){
  // crude cumulative renderer using the same logic as scoreGame()
  const rolls = readGame();
  let i = 0, total = 0;
  for (let f = 1; f <= 10; f++) {
    let add = 0;
    if (f < 10) {
      if (rolls[i] === 10) { add = 10 + (rolls[i+1]??0) + (rolls[i+2]??0); i += 1; }
      else {
        const frame = (rolls[i]??0) + (rolls[i+1]??0);
        add = (frame===10) ? 10 + (rolls[i+2]??0) : frame; i += 2;
      }
    } else {
      const a=rolls[i]??0, b=rolls[i+1]??0, c=rolls[i+2]??0;
      add = (a===10 || a+b===10) ? a+b+c : a+b;
    }
    total += add;
    const cell = document.querySelector(`.frameTotal[data-ft="${f}"]`);
    if (cell) cell.textContent = total ? String(total) : ' ';
  }
}
renderFrameTotals();

    // --- Frame 10: sum all legal balls (3rd only if strike/spare) ---
    const a = rolls[i]   ?? 0;
    const b = rolls[i+1] ?? 0;
    const c = rolls[i+2] ?? 0;

    if (a === 10) {              // X..
      total += a + b + c;
    } else if (a + b === 10) {   // spare
      total += a + b + c;
    } else {                     // open
      total += a + b;
    }
  }

  document.getElementById('gameTotal').textContent = total;
  return total;
}

framesRow.addEventListener('input', scoreGame);

/* ---------- storage & series ---------- */
const LSKEY='bowling.tracker.v1';
const $ = sel => document.querySelector(sel);
const pills = { g1:$('#g1Pill'), g2:$('#g2Pill'), g3:$('#g3Pill'), series:$('#seriesPill') };

function loadAll(){ try{ return JSON.parse(localStorage.getItem(LSKEY))||[] } catch{ return [] } }
function saveAll(arr){ localStorage.setItem(LSKEY, JSON.stringify(arr)); renderHistory(); }

function upsertNight(date, gnum, total, notes){
  const all=loadAll();
  let row=all.find(r=>r.date===date);
  if(!row){ row={date, g1:null, g2:null, g3:null, notes:{}}; all.push(row); }
  row['g'+gnum]=total;
  row.notes['g'+gnum]=notes||'';
  // derive
  const nums=[row.g1||0,row.g2||0,row.g3||0];
  row.series = nums.reduce((a,b)=>a+b,0);
  row.high = Math.max(...nums);
  row.low  = Math.min(...nums.filter(n=>n>0).concat([0]));
  saveAll(all);
  updatePills(date);
}
function updatePills(date){
  const row = loadAll().find(r=>r.date===date);
  pills.g1.textContent = 'G1: ' + (row?.g1??'—');
  pills.g2.textContent = 'G2: ' + (row?.g2??'—');
  pills.g3.textContent = 'G3: ' + (row?.g3??'—');
  pills.series.textContent = 'Series: ' + (row?.series??'—');
}

/* ---------- entry actions ---------- */
$('#saveGame').onclick = ()=>{
  const date = $('#date').value || new Date().toISOString().slice(0,10);
  const gnum = $('#gameNum').value;
  const total = scoreGame();
  const notes = $('#notes').value.trim();
  upsertNight(date, gnum, total, notes);
  alert(`Saved ${date} • Game ${gnum}: ${total}`);
};
$('#resetGame').onclick = ()=>{
  document.querySelectorAll('#framesRow input').forEach(i=>i.value='');
  $('#notes').value='';
  scoreGame();
};
$('#saveQuickNotes').onclick = ()=>{
  localStorage.setItem('bowling.quicknotes', $('#qNotes').value);
  $('#quickSaved').textContent = 'Saved ✔';
  setTimeout(()=>$('#quickSaved').textContent='',1500);
};
$('#qNotes').value = localStorage.getItem('bowling.quicknotes')||'';

/* ---------- history table ---------- */
function renderHistory(){
  const tb = document.querySelector('#histTable tbody');
  const rows = loadAll().sort((a,b)=> (a.date<b.date?-1:1));
  tb.innerHTML = rows.map(r=>`
    <tr>
      <td>${r.date}</td>
      <td>${r.g1??''}</td>
      <td>${r.g2??''}</td>
      <td>${r.g3??''}</td>
      <td>${r.high??''}</td>
      <td>${r.low??''}</td>
      <td><strong>${r.series??''}</strong></td>
      <td><button class="btn ghost" data-copy="${r.date}\t${r.g1||0}\t${r.g2||0}\t${r.g3||0}\t${r.high||0}\t${r.low||0}\t${r.series||0}">Copy</button></td>
    </tr>`).join('');
}
renderHistory();
document.querySelector('#histTable').onclick = e=>{
  const btn = e.target.closest('button[data-copy]');
  if(!btn) return;
  navigator.clipboard.writeText(btn.dataset.copy).then(()=> btn.textContent='Copied ✓');
};
$('#exportCSV').onclick = ()=>{
  const rows = loadAll();
  const header = 'Date,G1,G2,G3,High,Low,Series\n';
  const body = rows.map(r=>[r.date,r.g1||0,r.g2||0,r.g3||0,r.high||0,r.low||0,r.series||0].join(',')).join('\n');
  const blob = new Blob([header+body], {type:'text/csv'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='bowling-history.csv'; a.click();
};
$('#importBtn').onclick = ()=> $('#importCSV').click();
$('#importCSV').onchange = async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const text = await file.text();
  const lines = text.trim().split(/\r?\n/).slice(1);
  const rows = loadAll();
  for(const line of lines){
    const [date,g1,g2,g3,high,low,series] = line.split(',');
    let r = rows.find(x=>x.date===date);
    if(!r){ r={date,g1:+g1||0,g2:+g2||0,g3:+g3||0,notes:{}}; rows.push(r); }
    else { r.g1=+g1||0; r.g2=+g2||0; r.g3=+g3||0; }
    r.high=+high||Math.max(r.g1,r.g2,r.g3);
    r.low =+low || Math.min(...[r.g1,r.g2,r.g3].filter(n=>n>0));
    r.series=+series || (r.g1+r.g2+r.g3);
  }
  saveAll(rows);
};
document.getElementById('date').value = new Date().toISOString().slice(0,10);
</script>
</body>
</html>