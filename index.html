<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bowling League Tracker • Big Ben (44 ft)</title>

<style>
  /* ===== Static colors only ===== */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:#000; color:#e7ecf3;
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  .card{background:#171a21;border-radius:16px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.35)}
  h1{margin:0 0 8px;font-size:24px}
  h2{margin:12px 0 8px;font-size:18px;color:#9fb2cc}
  img{width:100%;height:auto;border-radius:12px}

  .grid2{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:900px){.grid2{grid-template-columns:1fr 1fr}}

  .tabs{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
  .tab{flex:1;text-align:center;padding:10px 12px;border-radius:10px;background:#0b0e13;color:#a9bfdc;cursor:pointer;border:1px solid #2a3140;min-width:140px}
  .tab.active{background:#2c84ff;color:#fff;border-color:#2c84ff;font-weight:700}

  label{font-size:14px;color:#cfe0fb;display:block;margin-bottom:4px}
  input,select,textarea{
    width:100%;background:#0b0e13;border:1px solid #2a3140;border-radius:10px;color:#e7ecf3;padding:10px
  }
  select.sm, input.sm{padding:6px 8px;font-size:12px;border-radius:8px}
  .btn{display:inline-block;background:#2c84ff;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.ghost{background:#0b0e13;border:1px solid #2a3140;color:#cfe0fb}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b0e13;border:1px solid #2a3140;color:#cfe0fb;font-size:12px}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 220px}
  .hint{font-size:13px;color:#9fb2cc}
  .foot{margin-top:10px;color:#9fb2cc;font-size:13px}

  .chip{display:inline-flex;align-items:center;gap:6px;background:#0b0e13;border:1px solid #2a3140;color:#cfe0fb;border-radius:16px;padding:3px 8px;margin:2px 4px 2px 0}
  .chip button{background:transparent;border:none;color:#9fb2cc;cursor:pointer}

  /* ===== Scoresheet ===== */
  #framesRow{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  @media (min-width:900px){#framesRow{grid-template-columns:repeat(10,1fr)}}

  .frameCard{background:#0b0e13;border:1px solid #2a3140;border-radius:10px;padding:8px;position:relative;min-height:136px}
  .frameHead{display:flex;justify-content:space-between;align-items:flex-start}
  .frameNum{font-weight:800;color:#cfe0fb}

  .shots{display:grid;grid-template-columns:repeat(2,28px);gap:6px}
  .shots.triple{grid-template-columns:repeat(3,28px)}

  .shot{
    width:28px;height:28px;padding:0;margin:0;
    text-align:center;
    font:900 18px/28px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    text-transform:uppercase; font-variant-numeric:tabular-nums;
    background:#0f1624; border:1px solid #3b4660; border-radius:4px;
    color:#ffffff !important; -webkit-text-fill-color:#ffffff !important;
    caret-color:#2c84ff; appearance:none;
  }
  .shot:focus{outline:2px solid #2c84ff}
  .shot[disabled]{opacity:.45}
  .shot, input, select, textarea { color-scheme: light; }
  input:-webkit-autofill{
    -webkit-text-fill-color:#ffffff !important;
    -webkit-box-shadow:0 0 0 1000px #0f1624 inset !important;
            box-shadow:0 0 0 1000px #0f1624 inset !important;
    transition: background-color 86400s;
  }

  /* per-frame ball selects */
  .ballRow{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px}
  .ballRow label{font-size:11px;color:#9fb2cc;margin-bottom:2px}
  .ballRow .grp{display:flex;flex-direction:column}

  .frameTotal{
    position:absolute;left:8px;right:8px;bottom:8px;height:34px;
    border:1px solid #3b4660;border-radius:6px;background:#111a2a;
    display:flex;align-items:center;justify-content:center;
    font-weight:900;font-size:18px;color:#fff;
  }

  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #2a3140;padding:6px 8px;text-align:center}
  thead th{background:#0b0e13;color:#cfe0fb}

  .statCard{background:#0b0e13;border:1px solid #2a3140;border-radius:12px;padding:12px;min-width:160px}
  .statBig{font-weight:900;font-size:22px}

  /* mini calendar */
  .miniCal{background:#0b0e13;border:1px solid #2a3140;border-radius:12px;padding:10px}
  .miniCal .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .miniCal .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
  .miniCal .cell{padding:8px 0;text-align:center;border-radius:8px}
  .miniCal .dow{color:#9fb2cc;font-size:12px}
  .miniCal .day{cursor:pointer;background:#0f1624;border:1px solid #2a3140}
  .miniCal .day:hover{outline:2px solid #2c84ff}
  .miniCal .today{border-color:#2c84ff}
  .miniCal .sel{background:#2c84ff;color:#fff}

  /* modal calendar */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:1000}
  .modal .panel{background:#171a21;border:1px solid #2a3140;border-radius:14px;padding:12px;max-width:360px;width:92%}
  .modal .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Bowling League Tracker • Big Ben (44 ft)</h1>

    <div class="tabs">
      <div class="tab active" data-panel="plan">Lane Plan</div>
      <div class="tab" data-panel="entry">Score Entry</div>
      <div class="tab" data-panel="history">History</div>
      <div class="tab" data-panel="analytics">Analytics</div>
      <div class="tab" data-panel="profile">Profile</div>
    </div>

    <!-- PLAN -->
    <section id="plan" class="panel">
      <div class="grid2">
        <div>
          <img src="assets/BigBen-LanePlan.png" alt="Big Ben lane plan">
          <p class="foot">Solid: Forge (~13 → 8 → pocket). Dashed: Jackal (~17 → 10 → pocket). Blue = oil to 44 ft.</p>
          <div class="flex">
            <a class="btn" href="assets/BigBen-LanePlan.png" download>Download PNG</a>
            <a class="btn ghost" href="sheets/League Night Entry (import to your tracker).xlsx" download>Entry Sheet (XLSX)</a>
          </div>
        </div>
        <div>
          <h2>Tonight’s Quick Notes</h2>
          <label for="qNotes">Optional — saved on this device</label>
          <textarea id="qNotes" rows="6" placeholder="e.g., Start Forge 13→8. If flat 10s by frame 5, move 2–1 or switch to Jackal."></textarea>
          <div class="flex">
            <button class="btn" id="saveQuickNotes">Save Notes</button>
            <span class="hint" id="quickSaved"></span>
          </div>

          <h2 style="margin-top:12px">Pick Night (Calendar)</h2>
          <div id="miniCal" class="miniCal"></div>
          <p class="foot">Selecting a day sets the **Date** on the Entry tab.</p>
        </div>
      </div>
    </section>

    <!-- ENTRY -->
    <section id="entry" class="panel" style="display:none">
      <h2>Score Entry (X, /, -, 0–9) — Auto-scoring</h2>

      <div class="row">
        <div class="col">
          <label for="date">Date</label>
          <div class="flex">
            <input id="date" type="date" style="flex:1">
            <button id="openCal" class="btn ghost" type="button">Pick from Calendar</button>
          </div>
        </div>
        <div class="col">
          <label for="gameNum">Game</label>
          <select id="gameNum">
            <option value="1">Game 1</option>
            <option value="2">Game 2</option>
            <option value="3">Game 3</option>
          </select>
        </div>
        <div class="col">
          <label>Active Strike Ball</label>
          <select id="entryStrikeBall"></select>
        </div>
        <div class="col">
          <label>Active Spare Ball</label>
          <select id="entrySpareBall"></select>
        </div>
        <div class="col">
          <label>Total</label>
          <div class="pill" id="gameTotal">0</div>
        </div>
        <div class="col" style="display:flex;gap:8px;align-items:flex-end">
          <button class="btn ghost" id="newNight" type="button">New Night</button>
          <button class="btn ghost" id="clearNight" type="button">Clear Night</button>
        </div>
      </div>

      <!-- LANE PAIR -->
      <div class="row">
        <div class="col">
          <label>Alley</label>
          <input id="entryAlley" placeholder="(from Profile)">
        </div>
        <div class="col">
          <label>Lane Pair</label>
          <div class="flex">
            <input class="sm" id="entryLaneA" inputmode="numeric" placeholder="Lane A">
            <span>—</span>
            <input class="sm" id="entryLaneB" inputmode="numeric" placeholder="Lane B">
          </div>
        </div>
        <div class="col">
          <label>Start on</label>
          <select id="entryStart" class="sm">
            <option value="A">Lane A</option>
            <option value="B">Lane B</option>
          </select>
        </div>
        <div class="col">
          <label>Starting lane (this game)</label>
          <div class="pill" id="startLanePill">—</div>
        </div>
      </div>

      <div id="framesRow" style="margin-top:8px"></div>

      <div style="margin-top:8px">
        <label for="notes">Notes for this game (saved with entry)</label>
        <textarea id="notes" rows="4" placeholder="e.g., Flat 10s frame 6, moved 2–1, carry improved."></textarea>
      </div>

      <div class="flex" style="margin-top:8px">
        <button class="btn" id="saveGame">Save Game</button>
        <button class="btn ghost" id="resetGame">Clear</button>
        <span class="hint">Tip: Enter 10th as X/X/X or 9/9 etc.</span>
      </div>

      <div class="flex" style="margin-top:6px">
        <span class="pill" id="g1Pill">G1: —</span>
        <span class="pill" id="g2Pill">G2: —</span>
        <span class="pill" id="g3Pill">G3: —</span>
        <span class="pill" id="seriesPill">Series: —</span>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="history" class="panel" style="display:none">
      <h2>History (saved on this device)</h2>

      <div class="flex" style="margin-bottom:8px">
        <div>
          <label for="seasonStart">Season start date (Week 1)</label>
          <input id="seasonStart" type="date">
        </div>
        <button class="btn" id="saveSeasonStart" type="button">Save Season Start</button>
        <span class="hint">Week # = weeks since this date (rounded up)</span>
      </div>

      <table id="histTable">
        <thead>
          <tr>
            <th>Week</th><th>Date</th>
            <th>Lane Pair</th><th>Start G1</th>
            <th>G1</th><th>G2</th><th>G3</th>
            <th>High</th><th>Low</th><th>Series</th>
            <th>HCP/Game</th><th>Series+HCP</th>
            <th>Copy</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="flex" style="margin-top:8px">
        <button class="btn ghost" id="exportCSV">Export CSV</button>
        <input type="file" id="importCSV" accept=".csv" style="display:none"/>
        <button class="btn ghost" id="importBtn">Import CSV</button>
        <button class="btn" id="clearAll">Clear All (device)</button>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section id="analytics" class="panel" style="display:none">
      <h2>Analytics</h2>

      <div class="flex" id="totalsBar"></div>

      <h2 style="margin-top:14px">By Ball (frame-accurate)</h2>
      <table id="ballBreakdown">
        <thead>
          <tr><th>Ball</th><th>Role</th><th>Games Used</th><th>Strikes</th><th>Spares</th><th>Opens</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <h2 style="margin-top:14px">Handicap Calculator</h2>
      <div class="row">
        <div class="col">
          <label>Base (e.g., 210)</label>
          <input id="hcpBase" inputmode="numeric">
        </div>
        <div class="col">
          <label>Percent (e.g., 90)</label>
          <input id="hcpPct" inputmode="numeric">
        </div>
        <div class="col">
          <label>Current Scratch Avg (auto)</label>
          <input id="curAvg" disabled>
        </div>
        <div class="col" style="display:flex;gap:8px;align-items:flex-end">
          <button class="btn" id="saveHcp">Save HCP Settings</button>
          <span class="hint" id="hcpSaved"></span>
        </div>
      </div>
      <p class="foot">Handicap per game = max(0, (Base − Average) × Percent%).</p>
    </section>

    <!-- PROFILE -->
    <section id="profile" class="panel" style="display:none">
      <h2>Player Data</h2>
      <div class="row">
        <div class="col"><label>First Name</label><input id="pFirst"></div>
        <div class="col"><label>Last Name</label><input id="pLast"></div>
        <div class="col"><label>Email</label><input id="pEmail" inputmode="email"></div>
        <div class="col"><label>Phone</label><input id="pPhone" inputmode="tel"></div>
      </div>
      <div class="row">
        <div class="col"><label>Years Bowling</label><input id="pYears" inputmode="numeric"></div>
        <div class="col"><label>Starting HDCP Score</label><input id="pStartHcp" inputmode="numeric"></div>
        <div class="col"><label>HCP Base (e.g., 210)</label><input id="pHcpBase" inputmode="numeric"></div>
        <div class="col"><label>HCP Percent (e.g., 90)</label><input id="pHcpPct" inputmode="numeric"></div>
      </div>

      <h2 style="margin-top:14px">Equipment</h2>
      <div class="row">
        <div class="col"><label>Strike Ball — Make</label><input id="sbMake"></div>
        <div class="col"><label>Strike Ball — Model</label><input id="sbModel"></div>
        <div class="col" style="display:flex;align-items:flex-end"><button class="btn" id="addStrikeBall">Add Strike Ball</button></div>
      </div>
      <div id="strikeList" class="flex"></div>

      <div class="row" style="margin-top:8px">
        <div class="col"><label>Spare Ball — Make</label><input id="spbMake"></div>
        <div class="col"><label>Spare Ball — Model</label><input id="spbModel"></div>
        <div class="col" style="display:flex;align-items:flex-end"><button class="btn" id="addSpareBall">Add Spare Ball</button></div>
      </div>
      <div id="spareList" class="flex"></div>

      <h2 style="margin-top:14px">Location</h2>
      <div class="row">
        <div class="col"><label>Bowling Alley Name</label><input id="locAlley"></div>
        <div class="col"><label>Number of Lanes</label><input id="locLanes" inputmode="numeric"></div>
      </div>

      <div class="flex" style="margin-top:10px">
        <button class="btn" id="saveProfile">Save Profile</button>
        <span class="hint" id="profileSaved"></span>
      </div>
    </section>
  </div>
</div>

<!-- Modal calendar -->
<div id="calModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="calTitle">
  <div class="panel">
    <div class="header">
      <strong id="calTitle">Pick a Date</strong>
      <button id="closeCal" class="btn ghost" type="button">Close</button>
    </div>
    <div id="modalCal"></div>
  </div>
</div>

<script>
/* ---------- tabs ---------- */
const tabs=[...document.querySelectorAll('.tab')];
tabs.forEach(t=>t.onclick=()=>{tabs.forEach(x=>x.classList.remove('active'));t.classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.style.display='none');
  document.getElementById(t.dataset.panel).style.display='block';
});

/* ---------- frames ---------- */
const framesRow=document.getElementById('framesRow');
function buildFrames(){
  framesRow.innerHTML='';
  for(let f=1; f<=10; f++){
    const triple=(f===10);
    const el=document.createElement('div');
    el.className='frameCard';
    el.innerHTML=`
      <div class="frameHead">
        <span class="frameNum">${f}</span>
        <div class="shots ${triple?'triple':''}">
          <input class="shot" data-f="${f}" data-r="1" maxlength="1" autocomplete="off" autocapitalize="characters" spellcheck="false">
          <input class="shot" data-f="${f}" data-r="2" maxlength="1" autocomplete="off" autocapitalize="characters" spellcheck="false">
          <input class="shot" data-f="${f}" data-r="3" maxlength="1" ${triple?'':'disabled'} autocomplete="off" autocapitalize="characters" spellcheck="false">
        </div>
      </div>
      <div class="ballRow">
        <div class="grp">
          <label>SB</label>
          <select class="sm frameSB" data-f="${f}"></select>
        </div>
        <div class="grp">
          <label>SP</label>
          <select class="sm frameSP" data-f="${f}"></select>
        </div>
      </div>
      <div class="frameTotal" data-ft="${f}"></div>`;
    framesRow.appendChild(el);
  }
  refreshPerFrameBallOptions();
}
buildFrames();

/* ---------- state & profile ---------- */
const LSKEY='bowling.tracker.v5'; // v5: frame snapshots + exact analytics + modal calendar
function defaultState(){
  return {
    seasonStart:new Date().toISOString().slice(0,10),
    profile:{
      player:{first:'',last:'',email:'',phone:'',years:'',startHcp:''},
      equipment:{strikeBalls:[], spareBalls:[]},
      location:{alley:'', lanes:''},
      handicap:{base:210, percent:90}
    },
    nights:[] // see upsertNight() for shape
  };
}
function loadState(){const raw=localStorage.getItem(LSKEY); return raw?JSON.parse(raw):defaultState();}
function saveState(s){localStorage.setItem(LSKEY,JSON.stringify(s));}

/* helpers */
function getProfile(){ return loadState().profile; }
function setProfile(p){ const s=loadState(); s.profile=p; saveState(s); }

/* ---------- equipment UI helpers ---------- */
function renderChips(){
  const p=getProfile();
  const strikeList=document.getElementById('strikeList'); strikeList.innerHTML='';
  p.equipment.strikeBalls.forEach((b,idx)=>{
    const div=document.createElement('div');
    div.className='chip'; div.innerHTML=`<span>${b.make} — ${b.model}</span> <button data-x="s${idx}" title="remove">✕</button>`;
    strikeList.appendChild(div);
  });
  const spareList=document.getElementById('spareList'); spareList.innerHTML='';
  p.equipment.spareBalls.forEach((b,idx)=>{
    const div=document.createElement('div');
    div.className='chip'; div.innerHTML=`<span>${b.make} — ${b.model}</span> <button data-x="p${idx}" title="remove">✕</button>`;
    spareList.appendChild(div);
  });
}
function optionize(arr){ return ['<option value="">(default)</option>'].concat(arr.map(b=>`<option>${b.make} — ${b.model}</option>`)).join(''); }
function refreshEquipmentSelects(){
  const p=getProfile();
  document.getElementById('entryStrikeBall').innerHTML = ['<option value="">(select)</option>'].concat(p.equipment.strikeBalls.map(b=>`<option>${b.make} — ${b.model}</option>`)).join('');
  document.getElementById('entrySpareBall').innerHTML  = ['<option value="">(select)</option>'].concat(p.equipment.spareBalls.map(b=>`<option>${b.make} — ${b.model}</option>`)).join('');
  refreshPerFrameBallOptions();
}
function refreshPerFrameBallOptions(){
  const p=getProfile();
  document.querySelectorAll('.frameSB').forEach(sel=> sel.innerHTML = optionize(p.equipment.strikeBalls));
  document.querySelectorAll('.frameSP').forEach(sel=> sel.innerHTML = optionize(p.equipment.spareBalls));
}

/* ---------- profile form load/save ---------- */
function loadProfileToForm(){
  const p=getProfile();
  // player
  ['pFirst','pLast','pEmail','pPhone','pYears','pStartHcp'].forEach(id=>{
    const key = {pFirst:'first',pLast:'last',pEmail:'email',pPhone:'phone',pYears:'years',pStartHcp:'startHcp'}[id];
    document.getElementById(id).value = p.player[key]||'';
  });
  // handicap
  document.getElementById('pHcpBase').value=p.handicap.base;
  document.getElementById('pHcpPct').value=p.handicap.percent;
  // location
  document.getElementById('locAlley').value=p.location.alley||'';
  document.getElementById('locLanes').value=p.location.lanes||'';
  // lists
  renderChips();
  refreshEquipmentSelects();
  // entry prefill for location
  document.getElementById('entryAlley').value=p.location.alley||'';
  // analytics HCP inputs
  document.getElementById('hcpBase').value=p.handicap.base;
  document.getElementById('hcpPct').value=p.handicap.percent;
}
loadProfileToForm();

document.getElementById('saveProfile').onclick=()=>{
  const p=getProfile();
  p.player.first=document.getElementById('pFirst').value.trim();
  p.player.last =document.getElementById('pLast').value.trim();
  p.player.email=document.getElementById('pEmail').value.trim();
  p.player.phone=document.getElementById('pPhone').value.trim();
  p.player.years=document.getElementById('pYears').value.trim();
  p.player.startHcp=document.getElementById('pStartHcp').value.trim();
  p.location.alley=document.getElementById('locAlley').value.trim();
  p.location.lanes=document.getElementById('locLanes').value.trim();
  p.handicap.base= Number(document.getElementById('pHcpBase').value)||210;
  p.handicap.percent= Number(document.getElementById('pHcpPct').value)||90;
  setProfile(p);
  loadProfileToForm();
  const el=document.getElementById('profileSaved'); el.textContent='Saved ✔'; setTimeout(()=>el.textContent='',1500);
};

document.getElementById('strikeList').onclick=(e)=>{
  const btn=e.target.closest('button[data-x]'); if(!btn) return;
  const idx=+btn.dataset.x.slice(1); const p=getProfile();
  p.equipment.strikeBalls.splice(idx,1); setProfile(p); renderChips(); refreshEquipmentSelects();
};
document.getElementById('spareList').onclick=(e)=>{
  const btn=e.target.closest('button[data-x]'); if(!btn) return;
  const idx=+btn.dataset.x.slice(1); const p=getProfile();
  p.equipment.spareBalls.splice(idx,1); setProfile(p); renderChips(); refreshEquipmentSelects();
};

document.getElementById('addStrikeBall').onclick=()=>{
  const make=document.getElementById('sbMake').value.trim();
  const model=document.getElementById('sbModel').value.trim();
  if(!make||!model) return alert('Enter Strike Ball make & model');
  const p=getProfile(); p.equipment.strikeBalls.push({make,model}); setProfile(p);
  document.getElementById('sbMake').value=''; document.getElementById('sbModel').value='';
  renderChips(); refreshEquipmentSelects();
};
document.getElementById('addSpareBall').onclick=()=>{
  const make=document.getElementById('spbMake').value.trim();
  const model=document.getElementById('spbModel').value.trim();
  if(!make||!model) return alert('Enter Spare Ball make & model');
  const p=getProfile(); p.equipment.spareBalls.push({make,model}); setProfile(p);
  document.getElementById('spbMake').value=''; document.getElementById('spbModel').value='';
  renderChips(); refreshEquipmentSelects();
};

/* ---------- scoring & stats ---------- */
function normalize(sym){ if(!sym) return ''; sym=sym.toUpperCase(); return /[X\/\-0-9]/.test(sym)?sym:''; }
framesRow.addEventListener('input', (e)=>{
  if(e.target.classList.contains('shot')){
    e.target.value = normalize(e.target.value.slice(0,1));
    scoreGame();
  }
});
function symToPins(sym, prev=0){
  if(!sym) return 0;
  sym=sym.toUpperCase();
  if(sym==='X') return 10;
  if(sym==='/') return Math.max(0,10-prev);
  if(sym==='-') return 0;
  const n=parseInt(sym,10); return isNaN(n)?0:n;
}
function readFrameSyms(f){
  const r1=document.querySelector(`input[data-f="${f}"][data-r="1"]`).value.toUpperCase();
  const r2=document.querySelector(`input[data-f="${f}"][data-r="2"]`).value.toUpperCase();
  const r3=document.querySelector(`input[data-f="${f}"][data-r="3"]`).value.toUpperCase();
  return [r1,r2,r3];
}
function readGame(){
  const rolls=[];
  for(let f=1; f<=10; f++){
    const [r1,r2,r3]=readFrameSyms(f);
    if(f<10){
      if(r1==='X'){ rolls.push(10); }
      else{ const p1=symToPins(r1), p2=symToPins(r2,p1); rolls.push(p1,p2); }
    }else{
      const p1=symToPins(r1);
      const p2=(r1==='X')?symToPins(r2):symToPins(r2,p1);
      const p3=(r2==='X'||r2==='/'||r1==='X')?symToPins(r3,(r2==='/')?0:p2):0;
      if(r1==='X'){ rolls.push(10); (r2==='X')?rolls.push(10,p3):rolls.push(p2,p3); }
      else { rolls.push(p1); (r2==='/')?rolls.push(10-p1,p3):rolls.push(p2); }
    }
  }
  return rolls;
}
function renderFrameTotals(){
  const rolls=readGame(); let i=0,total=0;
  for(let f=1; f<=10; f++){
    let add=0;
    if(f<10){
      if(rolls[i]===10){ add=10+(rolls[i+1]??0)+(rolls[i+2]??0); i+=1; }
      else{ const fr=(rolls[i]??0)+(rolls[i+1]??0); add=(fr===10)?10+(rolls[i+2]??0):fr; i+=2; }
    }else{
      const a=rolls[i]??0,b=rolls[i+1]??0,c=rolls[i+2]??0;
      add=(a===10||a+b===10)?a+b+c:a+b;
    }
    total+=add;
    const cell=document.querySelector(`.frameTotal[data-ft="${f}"]`);
    if(cell) cell.textContent=total?String(total):'';
  }
}
function scoreGame(){
  const rolls=readGame(); let i=0,total=0;
  for(let f=1; f<=10; f++){
    if(f<10){
      if(rolls[i]===10){ total+=10+(rolls[i+1]??0)+(rolls[i+2]??0); i+=1; }
      else{ const fr=(rolls[i]??0)+(rolls[i+1]??0); total+=(fr===10)?10+(rolls[i+2]??0):fr; i+=2; }
      continue;
    }
    const a=rolls[i]??0,b=rolls[i+1]??0,c=rolls[i+2]??0;
    total+=(a===10||a+b===10)?a+b+c:a+b;
  }
  document.getElementById('gameTotal').textContent=total;
  renderFrameTotals();
  return total;
}

/* ---------- nights & history ---------- */
function getNights(){ return loadState().nights; }
function saveNights(n){ const s=loadState(); s.nights=n; saveState(s); }
function weekNumberFor(dateStr, seasonStartStr) {
  const d0 = new Date(seasonStartStr + 'T00:00:00');
  const d1 = new Date(dateStr + 'T00:00:00');
  const msPerDay = 24*60*60*1000;
  const days = Math.floor((d1 - d0)/msPerDay);
  return Math.max(1, Math.floor(days/7) + 1);
}
function runningAverageUpTo(dateStr){
  const s=loadState();
  const rows=[...s.nights].filter(r=>r.date<=dateStr);
  const games=rows.reduce((acc,r)=>acc + (r.g1?1:0)+(r.g2?1:0)+(r.g3?1:0),0);
  if(!games) return 0;
  const pins=rows.reduce((acc,r)=>acc + (r.g1||0)+(r.g2||0)+(r.g3||0),0);
  return pins/games;
}
function hcpPerGameAt(dateStr){
  const p=getProfile();
  const avg=runningAverageUpTo(dateStr) || 0;
  const h = Math.max(0, Math.round((p.handicap.base - avg) * (p.handicap.percent/100)));
  return h;
}

/* per-frame ball resolve */
function collectFrameOverrides(){
  const fbs={};
  document.querySelectorAll('.frameSB').forEach(sel=>{
    const f=+sel.dataset.f; fbs[f]=fbs[f]||{}; fbs[f].sb = sel.value || '';
  });
  document.querySelectorAll('.frameSP').forEach(sel=>{
    const f=+sel.dataset.f; fbs[f]=fbs[f]||{}; fbs[f].sp = sel.value || '';
  });
  return fbs;
}
function ballForFrame(frame, kind, gameSB, gameSP, frameMap){
  const fb = frameMap?.[frame];
  if(kind==='strike') return (fb?.sb)||gameSB||'';
  if(kind==='spare')  return (fb?.sp)||gameSP||'';
  return '';
}

/* store exact frame snapshot for analytics */
function snapshotFrames(gameSB, gameSP, frameMap){
  const frames=[];
  for(let f=1; f<=10; f++){
    const [r1,r2,r3]=readFrameSyms(f);
    const sb = (frameMap?.[f]?.sb) || gameSB || '';
    const sp = (frameMap?.[f]?.sp) || gameSP || '';
    frames.push({f,r1,r2,r3,sb,sp});
  }
  return frames;
}

function upsertNight(date,gnum,total,notes, meta, lanes, frameMap, frames){
  const s=loadState();
  let row=s.nights.find(r=>r.date===date);
  if(!row){ row={date,g1:null,g2:null,g3:null,notes:{},series:0,high:0,low:0, meta:{}, lanes:null, frameBalls:{}, frames:{}}; s.nights.push(row); }
  row['g'+gnum]=total;
  row.notes['g'+gnum]=notes||'';
  row.meta['g'+gnum] = meta || {};
  if(lanes) row.lanes = lanes;
  if(frameMap) { row.frameBalls['g'+gnum] = frameMap; }
  if(frames)   { row.frames['g'+gnum]     = frames; }
  const nums=[row.g1||0,row.g2||0,row.g3||0];
  row.series=nums.reduce((a,b)=>a+b,0);
  row.high=Math.max(...nums);
  row.low =Math.min(...nums.filter(n=>n>0).concat([0]));
  saveState(s);
  renderHistory();
  renderAnalytics();
  updatePills(date);
}

function renderHistory(){
  const tb=document.querySelector('#histTable tbody');
  const s=loadState();
  if(!s.seasonStart && s.nights.length){ s.seasonStart=s.nights.map(n=>n.date).sort()[0]; saveState(s); }
  document.getElementById('seasonStart').value=s.seasonStart;

  const rows=[...s.nights].sort((a,b)=> (a.date<b.date?-1:1));
  tb.innerHTML = rows.map(r=>{
    const wk=weekNumberFor(r.date,s.seasonStart);
    const hcp = hcpPerGameAt(r.date);
    const gamesCount = (r.g1?1:0)+(r.g2?1:0)+(r.g3?1:0);
    const serHcp = (r.series||0) + hcp * gamesCount;
    const lp = r.lanes ? `${r.lanes.a || '?'}–${r.lanes.b || '?'}` : '—';
    const st = r.lanes ? (r.lanes.start || 'A') : '—';
    return `<tr>
      <td>${wk}</td>
      <td>${r.date}</td>
      <td>${lp}</td>
      <td>${st}</td>
      <td>${r.g1??''}</td>
      <td>${r.g2??''}</td>
      <td>${r.g3??''}</td>
      <td>${r.high??''}</td>
      <td>${r.low??''}</td>
      <td><strong>${r.series??''}</strong></td>
      <td>${hcp}</td>
      <td>${serHcp}</td>
      <td><button class="btn ghost" data-copy="${wk}\t${r.date}\t${lp}\t${st}\t${r.g1||0}\t${r.g2||0}\t${r.g3||0}\t${r.high||0}\t${r.low||0}\t${r.series||0}\t${hcp}\t${serHcp}">Copy</button></td>
    </tr>`;
  }).join('');
}
renderHistory();

/* history actions */
document.querySelector('#histTable').onclick = e=>{
  const btn=e.target.closest('button[data-copy]'); if(!btn) return;
  navigator.clipboard.writeText(btn.dataset.copy).then(()=> btn.textContent='Copied ✓');
};
document.getElementById('saveSeasonStart').onclick=()=>{
  const s=loadState();
  const val=document.getElementById('seasonStart').value;
  if(val){ s.seasonStart=val; saveState(s); renderHistory(); renderAnalytics(); }
};
document.getElementById('exportCSV').onclick=()=>{
  const s=loadState(); const header='Week,Date,LanePair,StartG1,G1,G2,G3,High,Low,Series,HCP/Game,Series+HCP\n';
  const body=s.nights
    .sort((a,b)=>a.date<b.date?-1:1)
    .map(r=>{
      const wk=weekNumberFor(r.date,s.seasonStart);
      const hcp=hcpPerGameAt(r.date);
      const gamesCount=(r.g1?1:0)+(r.g2?1:0)+(r.g3?1:0);
      const serHcp=(r.series||0)+hcp*gamesCount;
      const lp=r.lanes?`${r.lanes.a||'?'}–${r.lanes.b||'?'}`:'—';
      const st=r.lanes?(r.lanes.start||'A'):'—';
      return [wk,r.date,lp,st,r.g1||0,r.g2||0,r.g3||0,r.high||0,r.low||0,r.series||0,hcp,serHcp].join(',');
    }).join('\n');
  const blob=new Blob([header+body],{type:'text/csv'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='bowling-history.csv'; a.click();
};
document.getElementById('importBtn').onclick=()=>document.getElementById('importCSV').click();
document.getElementById('importCSV').onchange=async(e)=>{
  const file=e.target.files[0]; if(!file) return; const text=await file.text();
  const lines=text.trim().split(/\r?\n/); const head=lines.shift().toLowerCase().split(',');
  const idx=n=>head.indexOf(n);
  const iDate=idx('date'), iG1=idx('g1'), iG2=idx('g2'), iG3=idx('g3'), iHigh=idx('high'), iLow=idx('low'), iSeries=idx('series');
  const s=loadState();
  for(const ln of lines){ if(!ln.trim()) continue; const c=ln.split(',');
    const date=c[iDate]?.trim(); if(!date) continue;
    let r=s.nights.find(x=>x.date===date); if(!r){r={date,g1:0,g2:0,g3:0,notes:{},meta:{},lanes:null,frameBalls:{},frames:{}}; s.nights.push(r);}
    if(iG1>-1) r.g1=+c[iG1]||0; if(iG2>-1) r.g2=+c[iG2]||0; if(iG3>-1) r.g3=+c[iG3]||0;
    r.high=(iHigh>-1)?(+c[iHigh]||Math.max(r.g1,r.g2,r.g3)):Math.max(r.g1,r.g2,r.g3);
    r.low =(iLow>-1)?(+c[iLow] ||Math.min(...[r.g1,r.g2,r.g3].filter(n=>n>0))) :Math.min(...[r.g1,r.g2,r.g3].filter(n=>n>0));
    r.series=(iSeries>-1)?(+c[iSeries]||(r.g1+r.g2+r.g3)):(r.g1+r.g2+r.g3);
    if(!r.meta) r.meta={}; if(!r.frameBalls) r.frameBalls={}; if(!r.frames) r.frames={};
  }
  saveState(s); renderHistory(); renderAnalytics();
};

/* ---------- analytics (frame-accurate) ---------- */
function renderAnalytics(){
  const s=loadState();
  let strikes=0, spares=0, opens=0, games=0, pins=0;

  // ballAgg[name+role] keeps role specific tallies; we also show role in the table
  const ballAgg = {}; // key `${name}|Strike` or `${name}|Spare` -> {name,role,games,strikes,spares,opens}
  function bump(name, role, field, n=1){
    if(!name) return; const key = `${name}|${role}`;
    if(!ballAgg[key]) ballAgg[key] = {name, role, games:0, strikes:0, spares:0, opens:0};
    ballAgg[key][field] += n;
  }
  function markGameUse(name, role){
    if(!name) return; const key = `${name}|${role}`;
    if(!ballAgg[key]) ballAgg[key] = {name, role, games:0, strikes:0, spares:0, opens:0};
    ballAgg[key].games += 1;
  }

  s.nights.forEach(n=>{
    ['g1','g2','g3'].forEach(gk=>{
      const g = n[gk];
      if(g){ games++; pins+=g; }
      const frames = n.frames?.[gk] || [];          // [{f,r1,r2,r3,sb,sp}]
      const meta   = n.meta?.[gk]   || {};          // (still used for totals fallback)
      // Mark usage per game: any ball that shows up in frames gets "games used"
      const seen = new Set();
      frames.forEach(fr=>{
        if(fr.sb){ seen.add(fr.sb+'|Strike'); }
        if(fr.sp){ seen.add(fr.sp+'|Spare'); }
      });
      seen.forEach(k=>{ const [nm,role]=k.split('|'); markGameUse(nm,role); });

      // Tally per frame
      frames.forEach(fr=>{
        const {r1,r2,r3,sb,sp} = fr;
        if(fr.f<10){
          if(r1==='X'){ strikes++; bump(sb,'Strike','strikes'); return; }
          const p1=symToPins(r1), p2=symToPins(r2,p1);
          if(r2==='/'){ spares++; bump(sp,'Spare','spares'); }
          else if(p1+p2<10){ opens++; bump(sp||sb,'Spare','opens'); } // open → credit to 2nd shot ball preference
        }else{
          // 10th frame – handle rolls individually
          // strike(s)
          if(r1==='X'){ strikes++; bump(sb,'Strike','strikes'); }
          if(r2==='X'){ strikes++; bump(sb,'Strike','strikes'); } // most keep strike ball for fill; adjust manually if you switch via frame SP (rare)
          if(r3==='X'){ strikes++; bump(sb,'Strike','strikes'); }

          // spare(s)
          if(r2==='/'){ spares++; bump(sp,'Spare','spares'); }
          if(r3==='/'){ spares++; bump(sp,'Spare','spares'); }

          // open if first two < 10 and not spare
          const a=symToPins(r1), b=symToPins(r2,a);
          if(!(r1==='X') && (a+b<10)){ opens++; bump(sp||sb,'Spare','opens'); }
        }
      });

      // If no frame snapshots (older saves), fallback to meta totals into game-level selections
      if(!frames.length && (meta.strikes||meta.spares||meta.opens)){
        strikes += meta.strikes||0;
        spares  += meta.spares||0;
        opens   += meta.opens||0;
        if(meta.strikeBall){ markGameUse(meta.strikeBall,'Strike'); bump(meta.strikeBall,'Strike','strikes', meta.strikes||0); }
        if(meta.spareBall){  markGameUse(meta.spareBall,'Spare');   bump(meta.spareBall,'Spare','spares',  meta.spares||0); }
      }
    });
  });

  const avg = games ? (pins/games) : 0;
  const base = getProfile().handicap.base;
  const pct  = getProfile().handicap.percent;
  const hcpNow = Math.max(0, Math.round((base - avg) * (pct/100)));

  const tbar=document.getElementById('totalsBar');
  tbar.innerHTML = '';
  const mk=(lbl,val)=>{const d=document.createElement('div'); d.className='statCard'; d.innerHTML=`<div class="statBig">${val}</div><div class="hint">${lbl}</div>`; return d;};
  tbar.append(mk('Games',games),mk('Series Pins',pins),mk('Scratch Avg',avg?avg.toFixed(2):'—'),mk('Strikes',strikes),mk('Spares',spares),mk('Opens',opens),mk(`HCP/Game (Base ${base}, ${pct}%)`,hcpNow));

  const tb=document.querySelector('#ballBreakdown tbody');
  const rows = Object.values(ballAgg)
    .sort((a,b)=> (b.strikes+b.spares+b.opens) - (a.strikes+a.spares+a.opens))
    .map(obj=>`<tr><td>${obj.name}</td><td>${obj.role}</td><td>${obj.games}</td><td>${obj.strikes}</td><td>${obj.spares}</td><td>${obj.opens}</td></tr>`).join('');
  tb.innerHTML = rows || `<tr><td colspan="6" class="hint">Play a few games with frame snapshots to see per-ball attribution.</td></tr>`;

  document.getElementById('curAvg').value = avg?avg.toFixed(2):'0.00';
  document.getElementById('hcpBase').value = base;
  document.getElementById('hcpPct').value  = pct;
}
renderAnalytics();

document.getElementById('saveHcp').onclick=()=>{
  const p=getProfile();
  p.handicap.base = Number(document.getElementById('hcpBase').value)||210;
  p.handicap.percent = Number(document.getElementById('hcpPct').value)||90;
  setProfile(p);
  renderHistory(); renderAnalytics();
  const el=document.getElementById('hcpSaved'); el.textContent='Saved ✔'; setTimeout(()=>el.textContent='',1500);
};

/* ---------- entry actions ---------- */
function clearFrames(){
  document.querySelectorAll('#framesRow .shot').forEach(i=>i.value='');
  document.querySelectorAll('.frameSB,.frameSP').forEach(s=> s.value='');
  document.getElementById('notes').value=''; document.getElementById('gameTotal').textContent='0';
  renderFrameTotals();
}
function updatePills(date){
  const row=getNights().find(r=>r.date===date);
  document.getElementById('g1Pill').textContent='G1: ' + (row?.g1 ?? '—');
  document.getElementById('g2Pill').textContent='G2: ' + (row?.g2 ?? '—');
  document.getElementById('g3Pill').textContent='G3: ' + (row?.g3 ?? '—');
  document.getElementById('seriesPill').textContent='Series: ' + (row?.series ?? '—');
}
function refreshPillsFor(dateStr){
  updatePills(dateStr);
  const row = getNights().find(r=>r.date===dateStr);
  if (!row) {
    document.getElementById('g1Pill').textContent = 'G1: —';
    document.getElementById('g2Pill').textContent = 'G2: —';
    document.getElementById('g3Pill').textContent = 'G3: —';
    document.getElementById('seriesPill').textContent = 'Series: —';
  }
}

/* lane logic: auto swap start lane each game */
function computeStartLaneForGame(g){
  const startSel=document.getElementById('entryStart').value || 'A';
  return (Number(g)%2===1) ? startSel : (startSel==='A'?'B':'A');
}
function showStartLanePill(){
  const a=document.getElementById('entryLaneA').value||'?';
  const b=document.getElementById('entryLaneB').value||'?';
  const which=computeStartLaneForGame(document.getElementById('gameNum').value);
  const lane = (which==='A')?a:b;
  document.getElementById('startLanePill').textContent = lane?`Lane ${lane}`:'—';
}
['gameNum','entryStart','entryLaneA','entryLaneB'].forEach(id=>{
  document.getElementById(id).addEventListener('change', showStartLanePill);
});

document.getElementById('gameNum').addEventListener('change', clearFrames);
document.getElementById('date').addEventListener('change', (e)=>{ clearFrames(); refreshPillsFor(e.target.value); });

document.getElementById('newNight').onclick = ()=>{
  const today = new Date().toISOString().slice(0,10);
  document.getElementById('date').value = today;
  document.getElementById('gameNum').value = '1';
  clearFrames(); refreshPillsFor(today);
  const p=getProfile();
  document.getElementById('entryAlley').value=p.location.alley||'';
  refreshEquipmentSelects();
  showStartLanePill();
};

document.getElementById('clearNight').onclick = ()=>{
  const d = document.getElementById('date').value || new Date().toISOString().slice(0,10);
  if (!confirm(`Delete saved scores for ${d}? (Device only)`)) return;
  const all = getNights().filter(r => r.date !== d);
  saveNights(all); clearFrames(); refreshPillsFor(d);
  renderHistory(); renderAnalytics();
  alert('Night cleared.');
};

document.getElementById('saveGame').onclick = () => {
  const date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
  const gnum = document.getElementById('gameNum').value;
  const total = scoreGame();
  const notes = document.getElementById('notes').value.trim();

  const strikeBall = document.getElementById('entryStrikeBall').value || '';
  const spareBall  = document.getElementById('entrySpareBall').value || '';
  const frameMap   = collectFrameOverrides();
  const frames     = snapshotFrames(strikeBall, spareBall, frameMap); // ← exact snapshot

  // quick counts for alert
  let sC=0, spC=0, oC=0;
  frames.forEach(fr=>{
    if(fr.f<10){
      if(fr.r1==='X'){ sC++; return; }
      const p1=symToPins(fr.r1), p2=symToPins(fr.r2,p1);
      if(fr.r2==='/'){ spC++; } else if(p1+p2<10){ oC++; }
    }else{
      if(fr.r1==='X') sC++; if(fr.r2==='X') sC++; if(fr.r3==='X') sC++;
      if(fr.r2==='/') spC++; if(fr.r3==='/') spC++;
      const a=symToPins(fr.r1), b=symToPins(fr.r2,a);
      if(!(fr.r1==='X') && (a+b<10)) oC++;
    }
  });

  const lanes = {
    a: document.getElementById('entryLaneA').value.trim(),
    b: document.getElementById('entryLaneB').value.trim(),
    start: document.getElementById('entryStart').value || 'A'
  };

  upsertNight(
    date, gnum, total, notes,
    { strikes:sC, spares:spC, opens:oC, strikeBall, spareBall },
    lanes,
    frameMap,
    frames
  );

  alert(`Saved ${date} • Game ${gnum}: ${total}\nStrikes: ${sC} • Spares: ${spC} • Opens: ${oC}\nStarting lane: ${computeStartLaneForGame(gnum)}`);
  if (gnum === '1' || gnum === '2') {
    document.getElementById('gameNum').value = String(Number(gnum) + 1);
    clearFrames();
    showStartLanePill();
  }
  refreshPillsFor(date);
};
document.getElementById('resetGame').onclick = clearFrames;

/* quick notes */
document.getElementById('saveQuickNotes').onclick = ()=>{
  localStorage.setItem('bowling.quicknotes', document.getElementById('qNotes').value);
  const el=document.getElementById('quickSaved'); el.textContent='Saved ✔'; setTimeout(()=>el.textContent='',1500);
};
document.getElementById('qNotes').value = localStorage.getItem('bowling.quicknotes')||'';

/* ---------- mini + modal calendar ---------- */
function renderMiniCal(targetId, dateObj=new Date(), onPick){
  const el=document.getElementById(targetId);
  const y=dateObj.getFullYear(), m=dateObj.getMonth();
  const first=new Date(y,m,1);
  const startDay=(first.getDay()+6)%7; // Monday=0
  const daysInMonth=new Date(y,m+1,0).getDate();
  const today=new Date(); const todayStr=today.toISOString().slice(0,10);
  const selStr=(document.getElementById('date').value)||'';

  el.innerHTML='';
  const bar=document.createElement('div'); bar.className='bar';
  const prev=document.createElement('button'); prev.className='btn ghost'; prev.textContent='‹';
  const next=document.createElement('button'); next.className='btn ghost'; next.textContent='›';
  const title=document.createElement('div'); title.textContent = new Date(y,m,1).toLocaleString(undefined,{month:'long',year:'numeric'});
  bar.append(prev,title,next); el.append(bar);

  const grid=document.createElement('div'); grid.className='grid';
  ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d=>{const c=document.createElement('div'); c.className='cell dow'; c.textContent=d; grid.append(c);});
  for(let i=0;i<startDay;i++){ const c=document.createElement('div'); c.className='cell'; grid.append(c); }
  for(let d=1; d<=daysInMonth; d++){
    const c=document.createElement('div'); c.className='cell day';
    const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if(ds===todayStr) c.classList.add('today');
    if(ds===selStr) c.classList.add('sel');
    c.textContent=d; c.onclick=()=>{ if(onPick) onPick(ds); };
    grid.append(c);
  }
  el.append(grid);

  prev.onclick=()=>renderMiniCal(targetId,new Date(y,m-1,1),onPick);
  next.onclick=()=>renderMiniCal(targetId,new Date(y,m+1,1),onPick);
}
// Plan tab mini
renderMiniCal('miniCal', new Date(), (ds)=>{ document.getElementById('date').value=ds; tabs.find(t=>t.dataset.panel==='entry').click(); });

// Modal calendar
const calModal=document.getElementById('calModal');
const openCal=document.getElementById('openCal');
const closeCal=document.getElementById('closeCal');
openCal.onclick=()=>{ calModal.style.display='flex'; renderMiniCal('modalCal', new Date(), (ds)=>{ document.getElementById('date').value=ds; calModal.style.display='none'; }); };
closeCal.onclick=()=>{ calModal.style.display='none'; };
calModal.addEventListener('click',(e)=>{ if(e.target===calModal) calModal.style.display='none'; });

/* init defaults */
document.getElementById('date').value = new Date().toISOString().slice(0,10);
refreshEquipmentSelects();
renderAnalytics();
renderHistory();
showStartLanePill();
</script>
</body>
</html>